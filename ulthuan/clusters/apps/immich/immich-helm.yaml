apiVersion: v1
kind: Namespace
metadata:
  name: journal
---
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: immich-helm-repo
  namespace: journal
spec:
  type: "oci"
  interval: 10m # How often to check for updates
  url: oci://ghcr.io/immich-app/immich-charts
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: immich
  namespace: journal
spec:
  interval: 1m
  chart:
    spec:
      chart: immich
      version: "0.9.3" # {"$imagepolicy": "flux-system:immich-helm:tag"}
      sourceRef:
        kind: HelmRepository
        name: immich-helm-repo
  targetNamespace: journal
  values:
    env:
      REDIS_HOSTNAME: '{{ printf "%s-redis-master" .Release.Name }}'
      DB_HOSTNAME: "immich-labmouse"
      DB_USERNAME: "immich"
      DB_DATABASE_NAME: "immich"
      IMMICH_MACHINE_LEARNING_URL: '{{ printf "http://%s-machine-learning:3003" .Release.Name }}'
      DB_PASSWORD:
        valueFrom:
          secretKeyRef:
            name: immich-insight-clearance
            key: postgres-password
    image:
      tag: v1.144.1 # {"$imagepolicy": "flux-system:immich:tag"}
    immich:
      persistence:
        library:
          existingClaim: immich-library-project-insight
    redis:
      enabled: true
    server:
      ingress:
        main:
          enabled: true
          labels:
            tailscale.com/proxy-class: "irish-eyes"
          ingressClassName: tailscale
          annotations:
            # proxy-body-size is set to 0 to remove the body limit on file uploads
            nginx.ingress.kubernetes.io/proxy-body-size: "0"
          hosts:
            - host: memories
              paths:
                - path: "/"
          defaultBackend:
            service:
              name: project-insight-server
              port:
                number: 2283
          tls:
            - hosts:
                - memories
    machine-learning:
      persistence:
        cache:
          type: pvc
